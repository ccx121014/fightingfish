<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>划拳小鱼版</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 统一的 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#60a5fa',
                        accent: '#f472b6',
                        success: '#4ade80',
                        danger: '#f87171',
                        warning: '#facc15',
                        info: '#0ea5e9',
                        light: '#f3f4f6',
                        dark: '#1f2937'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-slow': 'pulse 3s infinite',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                    },
                    keyframes: {
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            }
            .text-shadow-lg {
                text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.5);
            }
            .bg-glass {
                background: rgba(255, 255, 255, 0.25);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.18);
            }
            .move-card {
                transition: all 0.3s ease;
            }
            .move-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .move-card:active {
                transform: translateY(0);
            }
            .move-card.disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .move-card.disabled:hover {
                transform: none;
                box-shadow: none;
            }
            .leaderboard-item {
                transition: all 0.2s ease;
            }
            .leaderboard-item:hover {
                background-color: rgba(255, 255, 255, 0.1);
            }
            .leaderboard-item.current-user {
                background-color: rgba(255, 215, 0, 0.2);
                border: 1px solid rgba(255, 215, 0, 0.3);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-500 to-purple-600 min-h-screen font-sans text-white">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- 游戏标题 -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-shadow-lg mb-2">划拳小鱼版</h1>
            <p class="text-xl text-blue-100">策略对战，谁是最终赢家？</p>
        </header>

        <!-- 主容器 -->
        <div id="app" class="bg-glass rounded-2xl shadow-2xl p-6 md:p-8">
            <!-- 登录界面 -->
            <div id="login-screen" class="screen active">
                <div class="max-w-md mx-auto">
                    <h2 class="text-3xl font-bold text-center mb-6">登录</h2>
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label for="login-username" class="block text-sm font-medium mb-1">用户名</label>
                            <input type="text" id="login-username" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:outline-none focus:ring-2 focus:ring-blue-300 text-white placeholder-blue-100" placeholder="请输入用户名">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium mb-1">密码</label>
                            <input type="password" id="login-password" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:outline-none focus:ring-2 focus:ring-blue-300 text-white placeholder-blue-100" placeholder="请输入密码">
                        </div>
                        <div class="flex items-center justify-between">
                            <button type="button" id="show-register" class="text-sm text-blue-200 hover:text-blue-100">没有账号？注册</button>
                            <button type="button" id="show-rules" class="text-sm text-blue-200 hover:text-blue-100">游戏规则</button>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-300">登录</button>
                    </form>
                </div>
            </div>

            <!-- 注册界面 -->
            <div id="register-screen" class="screen hidden">
                <div class="max-w-md mx-auto">
                    <h2 class="text-3xl font-bold text-center mb-6">注册</h2>
                    <form id="register-form" class="space-y-4">
                        <div>
                            <label for="register-username" class="block text-sm font-medium mb-1">用户名</label>
                            <input type="text" id="register-username" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:outline-none focus:ring-2 focus:ring-blue-300 text-white placeholder-blue-100" placeholder="请输入用户名">
                        </div>
                        <div>
                            <label for="register-password" class="block text-sm font-medium mb-1">密码</label>
                            <input type="password" id="register-password" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:outline-none focus:ring-2 focus:ring-blue-300 text-white placeholder-blue-100" placeholder="请输入密码">
                        </div>
                        <div>
                            <label for="register-confirm-password" class="block text-sm font-medium mb-1">确认密码</label>
                            <input type="password" id="register-confirm-password" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:outline-none focus:ring-2 focus:ring-blue-300 text-white placeholder-blue-100" placeholder="请再次输入密码">
                        </div>
                        <div class="flex items-center justify-between">
                            <button type="button" id="show-login" class="text-sm text-blue-200 hover:text-blue-100">已有账号？登录</button>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-300">注册</button>
                    </form>
                </div>
            </div>

            <!-- 游戏规则界面 -->
            <div id="rules-screen" class="screen hidden">
                <div class="max-w-2xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold">游戏规则</h2>
                        <button type="button" id="close-rules" class="text-2xl hover:text-blue-200">&times;</button>
                    </div>
                    <div class="bg-white/10 rounded-xl p-6 max-h-[70vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4">基本规则</h3>
                        <p class="mb-4">划拳小鱼版是一款基于传统划拳游戏的对战游戏。玩家通过选择不同的招式进行对战，目标是将对方干掉。</p>
                        
                        <h3 class="text-xl font-bold mb-4">招式说明</h3>
                        <div class="space-y-3">
                            <div class="p-3 bg-white/10 rounded-lg">
                                <span class="font-bold text-yellow-300">上弹：</span>
                                <span>子弹数量+1</span>
                            </div>
                            <div class="p-3 bg-white/10 rounded-lg">
                                <span class="font-bold text-yellow-300">单枪：</span>
                                <span>需要一颗子弹打出单枪，可以杀死上弹、波防、核防</span>
                            </div>
                            <div class="p-3 bg-white/10 rounded-lg">
                                <span class="font-bold text-yellow-300">双枪：</span>
                                <span>需要两颗子弹打出双枪，可以杀死上弹、波防和单枪、核防、地雷</span>
                            </div>
                            <div class="p-3 bg-white/10 rounded-lg">
                                <span class="font-bold text-yellow-300">普防：</span>
                                <span>可以防御单枪、双枪，不需要子弹</span>
                            </div>
                            <div class="p-3 bg-white/10 rounded-lg">
                                <span class="font-bold text-yellow-300">波：</span>
                                <span>需要三颗子弹打出波，可以杀死上弹、单枪、普防、单反、核防、地雷、双枪</span>
                            </div>
                            <div class="p-3 bg-white/10 rounded-lg">
                                <span class="font-bold text-yellow-300">波防：</span>
                                <span>可以防御波、小鱼，与波互相抵消，可以反弹地雷，不需要子弹</span>
                            </div>
                            <div class="p-3 bg-white/10 rounded-lg">
                                <span class="font-bold text-yellow-300">单反：</span>
                                <span>一局有两次，可以反弹全局单枪、双枪，不可以连出</span>
                            </div>
                            <div class="p-3 bg-white/10 rounded-lg">
                                <span class="font-bold text-yellow-300">巨反：</span>
                                <span>一局有一次，可以反弹全局（包括核弹）所有东西（不影响上弹），必须在第4回合及以后出</span>
                            </div>
                            <div class="p-3 bg-white/10 rounded-lg">
                                <span class="font-bold text-yellow-300">地雷：</span>
                                <span>一局有两次，必须在第4回合及以后出，可以杀死上弹、单枪，会被波防反弹</span>
                            </div>
                            <div class="p-3 bg-white/10 rounded-lg">
                                <span class="font-bold text-yellow-300">小鱼：</span>
                                <span>可以吸取别人的子弹，一局仅能出一次。如果有巨反，则会让吸的人子弹清空，被吸着获得吸的人先前的所有子弹。若有多个人吸一个人，则均分向上取整</span>
                            </div>
                            <div class="p-3 bg-white/10 rounded-lg">
                                <span class="font-bold text-yellow-300">核弹：</span>
                                <span>全局攻击，可以杀死除了核防和巨反的所有东西</span>
                            </div>
                            <div class="p-3 bg-white/10 rounded-lg">
                                <span class="font-bold text-yellow-300">核防：</span>
                                <span>可以防御核弹和地雷，不需要子弹</span>
                            </div>
                        </div>
                        
                        <h3 class="text-xl font-bold mt-6 mb-4">游戏模式</h3>
                        <div class="space-y-2">
                            <p><span class="font-bold text-yellow-300">单人匹配：</span>匹配真人玩家对决（积分差距最小）</p>
                            <p><span class="font-bold text-yellow-300">多人联机：</span>创建房间/快速加入/加入房间（输入房间号）</p>
                            <p><span class="font-bold text-yellow-300">练习模式：</span>分为简单，普通，困难模式，与AI对战</p>
                        </div>
                        
                        <h3 class="text-xl font-bold mt-6 mb-4">特殊机制</h3>
                        <div class="space-y-3">
                            <div class="p-3 bg-white/10 rounded-lg">
                                <span class="font-bold text-yellow-300">招式限制：</span>
                                <span>单反、巨反、地雷、小鱼均有使用次数限制</span>
                            </div>
                            <div class="p-3 bg-white/10 rounded-lg">
                                <span class="font-bold text-yellow-300">回合限制：</span>
                                <span>巨反、地雷仅能在第4回合及之后使用</span>
                            </div>
                            <div class="p-3 bg-white/10 rounded-lg">
                                <span class="font-bold text-yellow-300">连续限制：</span>
                                <span>单反、地雷不可连续使用</span>
                            </div>
                            <div class="p-3 bg-white/10 rounded-lg">
                                <span class="font-bold text-yellow-300">抵消规则：</span>
                                <span>小鱼与单反、单枪、双枪、地雷互相抵消；核防与地雷互相抵消</span>
                            </div>
                            <div class="p-3 bg-white/10 rounded-lg">
                                <span class="font-bold text-yellow-300">反弹规则：</span>
                                <span>波防可反弹地雷；巨反可反弹所有招式（除上弹）；单反仅反弹单枪、双枪</span>
                            </div>
                        </div>
                        
                        <h3 class="text-xl font-bold mt-6 mb-4">积分规则</h3>
                        <div class="space-y-2">
                            <p>每人初始为0，不会变成负数</p>
                            <p>单人获胜+2，失败-1</p>
                            <p>多人获胜+人数*2，失败-1</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 主菜单界面 -->
            <div id="menu-screen" class="screen hidden">
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-bold mb-2">欢迎，<span id="current-user" class="text-yellow-300">玩家</span>！</h2>
                    <p class="text-lg">当前积分：<span id="current-score" class="font-bold">0</span></p>
                </div>
                
                <!-- 积分排行榜 -->
                <div class="mb-8 bg-white/10 rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">积分排行榜</h3>
                        <button id="refresh-leaderboard" class="text-sm bg-blue-500/50 hover:bg-blue-500/70 px-3 py-1 rounded-lg transition-colors">
                            <i class="fa fa-refresh mr-1"></i> 刷新
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-white/20">
                                    <th class="text-left py-2 px-1">排名</th>
                                    <th class="text-left py-2 px-1">用户名</th>
                                    <th class="text-right py-2 px-1">积分</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard-body">
                                <!-- 排行榜内容将通过JS动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 text-sm text-center text-blue-100">
                        <p>数据每5分钟更新一次</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <button id="practice-mode" class="game-mode-btn bg-gradient-to-br from-green-500 to-green-700 rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                        <i class="fa fa-robot text-4xl mb-4"></i>
                        <h3 class="text-xl font-bold mb-2">练习模式</h3>
                        <p class="text-sm text-green-100">与AI对战，提升技巧</p>
                    </button>
                    
                    <button id="single-player" class="game-mode-btn bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                        <i class="fa fa-user text-4xl mb-4"></i>
                        <h3 class="text-xl font-bold mb-2">单人匹配</h3>
                        <p class="text-sm text-blue-100">匹配真实玩家对决</p>
                    </button>
                    
                    <button id="multi-player" class="game-mode-btn bg-gradient-to-br from-purple-500 to-purple-700 rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                        <i class="fa fa-users text-4xl mb-4"></i>
                        <h3 class="text-xl font-bold mb-2">多人联机</h3>
                        <p class="text-sm text-purple-100">创建或加入房间</p>
                    </button>
                </div>
                
                <div class="mt-8 flex justify-center space-x-4">
                    <button id="show-rules-from-menu" class="bg-white/20 hover:bg-white/30 text-white font-medium py-2 px-6 rounded-lg transition-colors duration-300">
                        游戏规则
                    </button>
                    <button id="logout" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-6 rounded-lg transition-colors duration-300">
                        退出登录
                    </button>
                </div>
            </div>

            <!-- 练习模式难度选择 -->
            <div id="difficulty-screen" class="screen hidden">
                <div class="max-w-md mx-auto text-center">
                    <h2 class="text-3xl font-bold mb-6">选择难度</h2>
                    
                    <div class="space-y-4">
                        <button data-difficulty="easy" class="difficulty-btn w-full bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300">
                            <h3 class="text-xl font-bold mb-2">简单</h3>
                            <p class="text-sm text-green-100">适合新手，AI随机出牌</p>
                        </button>
                        
                        <button data-difficulty="normal" class="difficulty-btn w-full bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300">
                            <h3 class="text-xl font-bold mb-2">普通</h3>
                            <p class="text-sm text-yellow-100">有一定策略，适合熟练玩家</p>
                        </button>
                        
                        <button data-difficulty="hard" class="difficulty-btn w-full bg-gradient-to-r from-red-500 to-red-600 rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300">
                            <h3 class="text-xl font-bold mb-2">困难</h3>
                            <p class="text-sm text-red-100">高级策略，极具挑战性</p>
                        </button>
                    </div>
                    
                    <button id="back-to-menu-from-difficulty" class="mt-8 bg-white/20 hover:bg-white/30 text-white font-medium py-2 px-6 rounded-lg transition-colors duration-300">
                        返回主菜单
                    </button>
                </div>
            </div>

            <!-- 多人联机界面 -->
            <div id="multiplayer-screen" class="screen hidden">
                <div class="max-w-md mx-auto">
                    <h2 class="text-3xl font-bold text-center mb-6">多人联机</h2>
                    
                    <div class="space-y-6">
                        <button id="create-room" class="w-full bg-gradient-to-r from-purple-500 to-purple-700 rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300">
                            <h3 class="text-xl font-bold mb-2">创建房间</h3>
                            <p class="text-sm text-purple-100">创建新房间等待其他玩家加入</p>
                        </button>
                        
                        <button id="quick-join" class="w-full bg-gradient-to-r from-blue-500 to-blue-700 rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300">
                            <h3 class="text-xl font-bold mb-2">快速加入</h3>
                            <p class="text-sm text-blue-100">自动加入有空位的房间</p>
                        </button>
                        
                        <div class="bg-white/10 rounded-xl p-6">
                            <h3 class="text-xl font-bold mb-4">输入房间号</h3>
                            <div class="flex space-x-2">
                                <input type="text" id="room-id" class="flex-1 px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:outline-none focus:ring-2 focus:ring-blue-300 text-white placeholder-blue-100" placeholder="房间号">
                                <button id="join-room" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition-colors duration-300 whitespace-nowrap">
                                    加入
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button id="back-to-menu-from-multiplayer" class="mt-8 bg-white/20 hover:bg-white/30 text-white font-medium py-2 px-6 rounded-lg transition-colors duration-300 w-full">
                        返回主菜单
                    </button>
                </div>
            </div>

            <!-- 局域网对战界面 -->
            <div id="lan-battle-screen" class="screen hidden">
                <div class="max-w-md mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold">局域网对战</h2>
                        <button id="back-to-menu-from-lan" class="text-2xl hover:text-blue-200">&times;</button>
                    </div>
                    
                    <div class="bg-white/10 rounded-xl p-6 mb-6">
                        <h3 class="text-xl font-bold mb-4">创建游戏</h3>
                        <div class="space-y-4">
                            <div class="p-4 bg-white/5 rounded-lg">
                                <p class="text-sm opacity-80 mb-1">你的IP地址</p>
                                <p class="font-mono font-bold" id="local-ip">192.168.1.100</p>
                            </div>
                            <div class="p-4 bg-white/5 rounded-lg">
                                <p class="text-sm opacity-80 mb-1">端口</p>
                                <p class="font-mono font-bold">8080</p>
                            </div>
                            <button id="create-lan-game" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-300">
                                创建游戏
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white/10 rounded-xl p-6">
                        <h3 class="text-xl font-bold mb-4">加入游戏</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="host-ip" class="block text-sm font-medium mb-1">主机IP地址</label>
                                <input type="text" id="host-ip" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:outline-none focus:ring-2 focus:ring-blue-300 text-white placeholder-blue-100" placeholder="请输入主机IP地址">
                            </div>
                            <div>
                                <label for="host-port" class="block text-sm font-medium mb-1">端口</label>
                                <input type="text" id="host-port" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:outline-none focus:ring-2 focus:ring-blue-300 text-white placeholder-blue-100" placeholder="请输入端口号" value="8080">
                            </div>
                            <button id="join-lan-game" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-300">
                                加入游戏
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-6 text-center text-sm text-blue-100">
                        <p>请确保所有玩家在同一局域网内</p>
                        <p class="mt-1">游戏将自动搜索局域网内的其他玩家</p>
                    </div>
                </div>
            </div>

            <!-- 游戏界面 -->
            <div id="game-screen" class="screen hidden">
                <!-- 游戏信息栏 -->
                <div class="flex justify-between items-center mb-6">
                    <div class="text-left">
                        <p class="text-sm opacity-80">游戏模式：<span id="game-mode-display">练习模式</span></p>
                        <p class="text-sm opacity-80">难度：<span id="difficulty-display">简单</span></p>
                    </div>
                    <div class="text-center">
                        <p class="text-xl font-bold">回合 <span id="round-counter">1</span></p>
                    </div>
                    <div>
                        <button id="exit-game" class="bg-red-600 hover:bg-red-700 text-white text-sm py-1 px-4 rounded-lg transition-colors duration-300">
                            退出游戏
                        </button>
                    </div>
                </div>
                
                <!-- 玩家信息 -->
                <div class="grid grid-cols-2 gap-6 mb-8">
                    <!-- 对手信息 -->
                    <div class="bg-white/10 rounded-xl p-4 text-center">
                        <p class="font-bold text-lg mb-2" id="opponent-name">对手</p>
                        <div class="flex justify-center items-center space-x-2 mb-2">
                            <i class="fa fa-bullseye text-yellow-400"></i>
                            <span id="opponent-bullets">0</span>
                        </div>
                        <div class="flex justify-center space-x-4 text-sm opacity-80">
                            <div>
                                <span class="block">单反</span>
                                <span id="opponent-single-reflect" class="font-bold">2</span>
                            </div>
                            <div>
                                <span class="block">巨反</span>
                                <span id="opponent-mega-reflect" class="font-bold">1</span>
                            </div>
                            <div>
                                <span class="block">地雷</span>
                                <span id="opponent-landmine" class="font-bold">2</span>
                            </div>
                            <div>
                                <span class="block">小鱼</span>
                                <span id="opponent-small-fish" class="font-bold">1</span>
                            </div>
                        </div>
                        <div class="mt-4 h-16 flex items-center justify-center">
                            <div id="opponent-move" class="text-2xl font-bold hidden">
                                上弹
                            </div>
                            <div id="opponent-thinking" class="flex flex-col items-center">
                                <div class="w-8 h-8 border-4 border-t-transparent border-white rounded-full animate-spin"></div>
                                <span class="mt-2 text-sm">思考中...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 玩家信息 -->
                    <div class="bg-white/10 rounded-xl p-4 text-center">
                        <p class="font-bold text-lg mb-2" id="player-name">玩家</p>
                        <div class="flex justify-center items-center space-x-2 mb-2">
                            <i class="fa fa-bullseye text-yellow-400"></i>
                            <span id="player-bullets">0</span>
                        </div>
                        <div class="flex justify-center space-x-4 text-sm opacity-80">
                            <div>
                                <span class="block">单反</span>
                                <span id="player-single-reflect" class="font-bold">2</span>
                            </div>
                            <div>
                                <span class="block">巨反</span>
                                <span id="player-mega-reflect" class="font-bold">1</span>
                            </div>
                            <div>
                                <span class="block">地雷</span>
                                <span id="player-landmine" class="font-bold">2</span>
                            </div>
                            <div>
                                <span class="block">小鱼</span>
                                <span id="player-small-fish" class="font-bold">1</span>
                            </div>
                        </div>
                        <div class="mt-4 h-16 flex items-center justify-center">
                            <div id="player-move" class="text-2xl font-bold hidden">
                                上弹
                            </div>
                            <div id="player-select" class="text-sm">
                                请选择招式
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 战斗结果区域 -->
                <div id="battle-result" class="bg-white/10 rounded-xl p-4 mb-8 text-center hidden">
                    <p class="text-xl font-bold" id="result-text">战斗结果</p>
                    <p class="text-lg" id="result-description">详细描述</p>
                </div>
                
                <!-- 招式选择区域 -->
                <div id="moves-container" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- 上弹 -->
                    <div class="move-card bg-white/10 hover:bg-white/20 rounded-xl p-4 cursor-pointer" data-move="reload">
                        <h3 class="font-bold text-center mb-2">上弹</h3>
                        <p class="text-xs text-center opacity-80">子弹数量+1</p>
                        <div class="mt-2 text-center text-sm">
                            <span class="bg-blue-500/50 px-2 py-1 rounded">消耗: 0</span>
                        </div>
                    </div>
                    
                    <!-- 单枪 -->
                    <div class="move-card bg-white/10 hover:bg-white/20 rounded-xl p-4 cursor-pointer" data-move="singleGun">
                        <h3 class="font-bold text-center mb-2">单枪</h3>
                        <p class="text-xs text-center opacity-80">杀死上弹、波防、核防</p>
                        <div class="mt-2 text-center text-sm">
                            <span class="bg-blue-500/50 px-2 py-1 rounded">消耗: 1</span>
                        </div>
                    </div>
                    
                    <!-- 双枪 -->
                    <div class="move-card bg-white/10 hover:bg-white/20 rounded-xl p-4 cursor-pointer" data-move="doubleGun">
                        <h3 class="font-bold text-center mb-2">双枪</h3>
                        <p class="text-xs text-center opacity-80">杀死上弹、波防、单枪、核防、地雷</p>
                        <div class="mt-2 text-center text-sm">
                            <span class="bg-blue-500/50 px-2 py-1 rounded">消耗: 2</span>
                        </div>
                    </div>
                    
                    <!-- 普防 -->
                    <div class="move-card bg-white/10 hover:bg-white/20 rounded-xl p-4 cursor-pointer" data-move="normalShield">
                        <h3 class="font-bold text-center mb-2">普防</h3>
                        <p class="text-xs text-center opacity-80">防御单枪、双枪</p>
                        <div class="mt-2 text-center text-sm">
                            <span class="bg-blue-500/50 px-2 py-1 rounded">消耗: 0</span>
                        </div>
                    </div>
                    
                    <!-- 波 -->
                    <div class="move-card bg-white/10 hover:bg-white/20 rounded-xl p-4 cursor-pointer" data-move="wave">
                        <h3 class="font-bold text-center mb-2">波</h3>
                        <p class="text-xs text-center opacity-80">杀死上弹、单枪、普防、单反、核防、地雷、双枪</p>
                        <div class="mt-2 text-center text-sm">
                            <span class="bg-blue-500/50 px-2 py-1 rounded">消耗: 3</span>
                        </div>
                    </div>
                    
                    <!-- 波防 -->
                    <div class="move-card bg-white/10 hover:bg-white/20 rounded-xl p-4 cursor-pointer" data-move="waveShield">
                        <h3 class="font-bold text-center mb-2">波防</h3>
                        <p class="text-xs text-center opacity-80">防御波、小鱼，反弹地雷</p>
                        <div class="mt-2 text-center text-sm">
                            <span class="bg-blue-500/50 px-2 py-1 rounded">消耗: 0</span>
                        </div>
                    </div>
                    
                    <!-- 单反 -->
                    <div class="move-card bg-white/10 hover:bg-white/20 rounded-xl p-4 cursor-pointer" data-move="singleReflect">
                        <h3 class="font-bold text-center mb-2">单反</h3>
                        <p class="text-xs text-center opacity-80">反弹全局单枪、双枪</p>
                        <div class="mt-2 text-center text-sm">
                            <span class="bg-purple-500/50 px-2 py-1 rounded">剩余: <span id="single-reflect-count">2</span></span>
                        </div>
                    </div>
                    
                    <!-- 巨反 -->
                    <div class="move-card bg-white/10 hover:bg-white/20 rounded-xl p-4 cursor-pointer disabled" data-move="megaReflect">
                        <h3 class="font-bold text-center mb-2">巨反</h3>
                        <p class="text-xs text-center opacity-80">反弹全局所有东西(第4回合可用)</p>
                        <div class="mt-2 text-center text-sm">
                            <span class="bg-purple-500/50 px-2 py-1 rounded">剩余: <span id="mega-reflect-count">1</span></span>
                        </div>
                    </div>
                    
                    <!-- 地雷 -->
                    <div class="move-card bg-white/10 hover:bg-white/20 rounded-xl p-4 cursor-pointer disabled" data-move="landmine">
                        <h3 class="font-bold text-center mb-2">地雷</h3>
                        <p class="text-xs text-center opacity-80">杀死上弹、单枪(第4回合可用)</p>
                        <div class="mt-2 text-center text-sm">
                            <span class="bg-purple-500/50 px-2 py-1 rounded">剩余: <span id="landmine-count">2</span></span>
                        </div>
                    </div>
                    
                    <!-- 小鱼 -->
                    <div class="move-card bg-white/10 hover:bg-white/20 rounded-xl p-4 cursor-pointer" data-move="smallFish">
                        <h3 class="font-bold text-center mb-2">小鱼</h3>
                        <p class="text-xs text-center opacity-80">吸取别人的子弹</p>
                        <div class="mt-2 text-center text-sm">
                            <span class="bg-purple-500/50 px-2 py-1 rounded">剩余: <span id="small-fish-count">1</span></span>
                        </div>
                    </div>
                    
                    <!-- 核弹 -->
                    <div class="move-card bg-white/10 hover:bg-white/20 rounded-xl p-4 cursor-pointer" data-move="nuke">
                        <h3 class="font-bold text-center mb-2">核弹</h3>
                        <p class="text-xs text-center opacity-80">全局攻击(需要5颗子弹)</p>
                        <div class="mt-2 text-center text-sm">
                            <span class="bg-blue-500/50 px-2 py-1 rounded">消耗: 5</span>
                        </div>
                    </div>
                    
                    <!-- 核防 -->
                    <div class="move-card bg-white/10 hover:bg-white/20 rounded-xl p-4 cursor-pointer" data-move="nukeShield">
                        <h3 class="font-bold text-center mb-2">核防</h3>
                        <p class="text-xs text-center opacity-80">防御核弹和地雷</p>
                        <div class="mt-2 text-center text-sm">
                            <span class="bg-blue-500/50 px-2 py-1 rounded">消耗: 0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 游戏结束界面 -->
            <div id="game-over-screen" class="screen hidden">
                <div class="max-w-md mx-auto text-center">
                    <h2 class="text-3xl font-bold mb-6" id="game-result-title">游戏结束</h2>
                    <p class="text-xl mb-8" id="game-result-message">详细信息</p>
                    
                    <div class="bg-white/10 rounded-xl p-6 mb-8">
                        <h3 class="text-xl font-bold mb-4">战斗数据</h3>
                        <div class="space-y-3 text-left">
                            <div class="flex justify-between">
                                <span>游戏模式:</span>
                                <span id="result-game-mode" class="font-bold">练习模式</span>
                            </div>
                            <div class="flex justify-between">
                                <span>难度:</span>
                                <span id="result-difficulty" class="font-bold">简单</span>
                            </div>
                            <div class="flex justify-between">
                                <span>回合数:</span>
                                <span id="result-rounds" class="font-bold">5</span>
                            </div>
                            <div class="flex justify-between">
                                <span>积分变化:</span>
                                <span id="result-score-change" class="font-bold text-green-400">+2</span>
                            </div>
                            <div class="flex justify-between">
                                <span>当前积分:</span>
                                <span id="result-current-score" class="font-bold">10</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button id="play-again" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-300">
                            再来一局
                        </button>
                        <button id="back-to-menu-from-game-over" class="flex-1 bg-white/20 hover:bg-white/30 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-300">
                            返回主菜单
                        </button>
                    </div>
                </div>
            </div>

            <!-- 多人游戏房间界面 -->
            <div id="room-screen" class="screen hidden">
                <div class="max-w-md mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold">房间</h2>
                        <div>
                            <span class="text-lg">房间号: <span id="current-room-id" class="font-bold">12345</span></span>
                        </div>
                    </div>
                    
                    <div class="bg-white/10 rounded-xl p-6 mb-6">
                        <h3 class="text-xl font-bold mb-4">玩家列表</h3>
                        <div id="player-list" class="space-y-3">
                            <div class="flex justify-between items-center p-2 bg-white/10 rounded-lg">
                                <span class="font-bold">玩家1</span>
                                <span class="text-green-400">准备</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-white/10 rounded-lg">
                                <span class="font-bold">玩家2</span>
                                <span class="text-yellow-400">等待</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-white/10 rounded-lg">
                                <span class="font-bold">玩家3</span>
                                <span class="text-yellow-400">等待</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button id="ready-up" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-300">
                            准备
                        </button>
                        <button id="leave-room" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-300">
                            离开房间
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知提示 -->
    <div id="notification" class="fixed bottom-4 right-4 bg-white/10 backdrop-blur-md border border-white/20 rounded-lg p-4 shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 max-w-xs">
        <div class="flex items-start">
            <div id="notification-icon" class="mr-3 text-lg">
                <i class="fa fa-info-circle text-blue-400"></i>
            </div>
            <div class="flex-1">
                <h4 id="notification-title" class="font-bold text-sm mb-1">通知标题</h4>
                <p id="notification-message" class="text-xs opacity-80">通知内容</p>
            </div>
            <button id="close-notification" class="text-white/50 hover:text-white">
                <i class="fa fa-times"></i>
            </button>
        </div>
    </div>

    <script>
        // 游戏数据
        const gameData = {
            currentUser: null,
            users: JSON.parse(localStorage.getItem('fishGameUsers')) || {},
            gameState: {
                currentRound: 1,
                playerBullets: 0,
                opponentBullets: 0,
                playerSpecialMoves: {
                    singleReflect: 2,
                    megaReflect: 1,
                    landmine: 2,
                    smallFish: 1
                },
                opponentSpecialMoves: {
                    singleReflect: 2,
                    megaReflect: 1,
                    landmine: 2,
                    smallFish: 1
                },
                gameMode: "practice", // practice, singlePlayer, multiPlayer
                difficulty: "easy", // easy, normal, hard
                roomId: null,
                isPlayerTurn: true,
                lastPlayerMove: null,
                lastOpponentMove: null,
                isGameOver: false,
                winner: null,
                scoreChange: 0
            },
            // 招式数据
            moves: {
                reload: {
                    name: "上弹",
                    cost: 0,
                    description: "子弹数量+1",
                    counters: []
                },
                singleGun: {
                    name: "单枪",
                    cost: 1,
                    description: "需要一颗子弹打出单枪，可以杀死上弹、波防、核防",
                    counters: ["reload", "waveShield", "nukeShield"]
                },
                doubleGun: {
                    name: "双枪",
                    cost: 2,
                    description: "需要两颗子弹打出双枪，可以杀死上弹、波防和单枪、核防、地雷",
                    counters: ["reload", "waveShield", "singleGun", "nukeShield", "landmine"]
                },
                normalShield: {
                    name: "普防",
                    cost: 0,
                    description: "可以防御单枪、双枪，会被波杀死，不需要子弹",
                    counters: ["singleGun", "doubleGun"]
                },
                wave: {
                    name: "波",
                    cost: 3,
                    description: "需要三颗子弹打出波，可以杀死上弹、单枪、普防、单反、核防、地雷、双枪和小鱼",
                    counters: ["reload", "singleGun", "normalShield", "singleReflect", "nukeShield", "landmine", "doubleGun", "smallFish"]
                },
                waveShield: {
                    name: "波防",
                    cost: 0,
                    description: "可以防御波，可以反弹地雷，不需要子弹",
                    counters: ["wave", "landmine"]
                },
                singleReflect: {
                    name: "单反",
                    cost: 0,
                    description: "一局有两次，可以反弹全局单枪、双枪，不可以连出，与小鱼抵消",
                    counters: ["singleGun", "doubleGun"],
                    maxUses: 2
                },
                megaReflect: {
                    name: "巨反",
                    cost: 0,
                    description: "一局有一次，可以反弹全局（包括核弹）所有东西（不影响上弹），必须在第4回合及以后出",
                    counters: ["singleGun", "doubleGun", "wave", "nuke", "landmine"],
                    maxUses: 1,
                    minRound: 4
                },
                landmine: {
                    name: "地雷",
                    cost: 0,
                    description: "一局有两次，必须在第4回合及以后出，可以杀死上弹、单枪，不消耗子弹，不能连出，与小鱼抵消",
                    counters: ["reload", "singleGun"],
                    maxUses: 2,
                    minRound: 4
                },
                smallFish: {
                    name: "小鱼",
                    cost: 0,
                    description: "可以吸取别人的所有子弹，一局仅能出一次，与单反、单枪、双枪、地雷抵消，会被波、核弹杀死",
                    maxUses: 1
                },
                nuke: {
                    name: "核弹",
                    cost: 5,
                    description: "全局攻击，可以杀死除了核防和巨反的所有东西，包括小鱼",
                    counters: ["reload", "singleGun", "doubleGun", "normalShield", "wave", "waveShield", "singleReflect", "landmine", "smallFish"]
                },
                nukeShield: {
                    name: "核防",
                    cost: 0,
                    description: "可以防御核弹和地雷，不需要子弹",
                    counters: ["nuke", "landmine"]
                }
            }
        };

        // DOM元素
        const screens = {
            login: document.getElementById('login-screen'),
            register: document.getElementById('register-screen'),
            rules: document.getElementById('rules-screen'),
            menu: document.getElementById('menu-screen'),
            difficulty: document.getElementById('difficulty-screen'),
            multiplayer: document.getElementById('multiplayer-screen'),
            game: document.getElementById('game-screen'),
            gameOver: document.getElementById('game-over-screen'),
            room: document.getElementById('room-screen')
        };

        // 显示通知
        function showNotification(title, message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notification-title');
            const notificationMessage = document.getElementById('notification-message');
            const notificationIcon = document.getElementById('notification-icon');
            
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            
            // 设置图标和颜色
            let iconClass = 'fa-info-circle text-blue-400';
            if (type === 'success') {
                iconClass = 'fa-check-circle text-green-400';
            } else if (type === 'error') {
                iconClass = 'fa-exclamation-circle text-red-400';
            } else if (type === 'warning') {
                iconClass = 'fa-exclamation-triangle text-yellow-400';
            }
            
            notificationIcon.innerHTML = `<i class="fa ${iconClass}"></i>`;
            
            // 显示通知
            notification.classList.remove('translate-y-20', 'opacity-0');
            
            // 3秒后自动隐藏
            setTimeout(() => {
                hideNotification();
            }, 3000);
        }

        // 隐藏通知
        function hideNotification() {
            const notification = document.getElementById('notification');
            notification.classList.add('translate-y-20', 'opacity-0');
        }

        // 显示局域网对战界面
        function showLanBattleScreen() {
            // 模拟获取本地IP地址
            const localIP = '192.168.1.' + Math.floor(Math.random() * 254) + 1;
            document.getElementById('local-ip').textContent = localIP;
            
            showScreen('lan-battle-screen');
        }

        // 切换屏幕
        function showScreen(screenId) {
            Object.values(screens).forEach(screen => {
                screen.classList.add('hidden');
                screen.classList.remove('active');
            });
            
            const screen = screens[screenId];
            screen.classList.remove('hidden');
            screen.classList.add('active');
            
            // 如果是主菜单，更新排行榜
            if (screenId === 'menu') {
                updateLeaderboard();
            }
        }

        // 更新积分排行榜
        function updateLeaderboard() {
            const leaderboardBody = document.getElementById('leaderboard-body');
            leaderboardBody.innerHTML = '';
            
            // 将用户转换为数组并按积分排序
            const sortedUsers = Object.values(gameData.users)
                .sort((a, b) => b.score - a.score)
                .slice(0, 10); // 只显示前10名
            
            // 如果没有用户数据
            if (sortedUsers.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="3" class="py-4 text-center">暂无玩家数据</td>
                `;
                leaderboardBody.appendChild(row);
                return;
            }
            
            // 生成排行榜条目
            sortedUsers.forEach((user, index) => {
                const row = document.createElement('tr');
                row.className = `leaderboard-item ${user.username === gameData.currentUser?.username ? 'current-user' : ''}`;
                
                // 前三名添加特殊样式
                let rankClass = '';
                let rankIcon = '';
                
                if (index === 0) {
                    rankClass = 'text-yellow-400 font-bold';
                    rankIcon = '<i class="fa fa-trophy mr-1"></i>';
                } else if (index === 1) {
                    rankClass = 'text-gray-300 font-bold';
                    rankIcon = '<i class="fa fa-trophy mr-1"></i>';
                } else if (index === 2) {
                    rankClass = 'text-yellow-700 font-bold';
                    rankIcon = '<i class="fa fa-trophy mr-1"></i>';
                }
                
                row.innerHTML = `
                    <td class="py-2 px-1 ${rankClass}">${rankIcon}${index + 1}</td>
                    <td class="py-2 px-1">${user.username}</td>
                    <td class="py-2 px-1 text-right font-medium">${user.score}</td>
                `;
                
                leaderboardBody.appendChild(row);
            });
        }

        // 更新游戏状态显示
        function updateGameStateDisplay() {
            // 更新回合数
            document.getElementById('round-counter').textContent = gameData.gameState.currentRound;
            
            // 更新子弹数
            document.getElementById('player-bullets').textContent = gameData.gameState.playerBullets;
            document.getElementById('opponent-bullets').textContent = gameData.gameState.opponentBullets;
            
            // 更新特殊招式次数
            document.getElementById('player-single-reflect').textContent = gameData.gameState.playerSpecialMoves.singleReflect;
            document.getElementById('player-mega-reflect').textContent = gameData.gameState.playerSpecialMoves.megaReflect;
            document.getElementById('player-landmine').textContent = gameData.gameState.playerSpecialMoves.landmine;
            document.getElementById('player-small-fish').textContent = gameData.gameState.playerSpecialMoves.smallFish;
            
            document.getElementById('opponent-single-reflect').textContent = gameData.gameState.opponentSpecialMoves.singleReflect;
            document.getElementById('opponent-mega-reflect').textContent = gameData.gameState.opponentSpecialMoves.megaReflect;
            document.getElementById('opponent-landmine').textContent = gameData.gameState.opponentSpecialMoves.landmine;
            document.getElementById('opponent-small-fish').textContent = gameData.gameState.opponentSpecialMoves.smallFish;
            
            // 更新招式按钮显示
            document.getElementById('single-reflect-count').textContent = gameData.gameState.playerSpecialMoves.singleReflect;
            document.getElementById('mega-reflect-count').textContent = gameData.gameState.playerSpecialMoves.megaReflect;
            document.getElementById('landmine-count').textContent = gameData.gameState.playerSpecialMoves.landmine;
            document.getElementById('small-fish-count').textContent = gameData.gameState.playerSpecialMoves.smallFish;
            
            // 更新招式按钮状态
            updateMoveButtonsState();
        }

        // 更新招式按钮状态
        function updateMoveButtonsState() {
            const moveCards = document.querySelectorAll('.move-card');
            
            moveCards.forEach(card => {
                const moveId = card.dataset.move;
                const move = gameData.moves[moveId];
                
                // 重置状态
                card.classList.remove('disabled');
                
                // 检查子弹是否足够
                if (move.cost > gameData.gameState.playerBullets) {
                    card.classList.add('disabled');
                }
                
                // 检查特殊招式使用次数
                if (moveId === 'singleReflect' && gameData.gameState.playerSpecialMoves.singleReflect <= 0) {
                    card.classList.add('disabled');
                }
                
                if (moveId === 'megaReflect') {
                    if (gameData.gameState.playerSpecialMoves.megaReflect <= 0 || gameData.gameState.currentRound < 4) {
                        card.classList.add('disabled');
                    }
                }
                
                if (moveId === 'landmine') {
                    if (gameData.gameState.playerSpecialMoves.landmine <= 0 || gameData.gameState.currentRound < 4) {
                        card.classList.add('disabled');
                    }
                }
                
                if (moveId === 'smallFish' && gameData.gameState.playerSpecialMoves.smallFish <= 0) {
                    card.classList.add('disabled');
                }
                
                // 检查是否可以连出单反或地雷
                if ((moveId === 'singleReflect' || moveId === 'landmine') && gameData.gameState.lastPlayerMove === moveId) {
                    card.classList.add('disabled');
                }
                
                // 如果不是玩家回合，禁用所有按钮
                if (!gameData.gameState.isPlayerTurn) {
                    card.classList.add('disabled');
                }
            });
        }

        // 处理玩家选择招式
        function handlePlayerMove(moveId) {
            if (!gameData.gameState.isPlayerTurn || gameData.gameState.isGameOver) {
                return;
            }
            
            const move = gameData.moves[moveId];
            const moveCard = document.querySelector(`[data-move="${moveId}"]`);
            
            // 检查是否可以使用该招式
            if (moveCard.classList.contains('disabled')) {
                showNotification('无法使用', '你不能使用这个招式', 'error');
                return;
            }
            
            // 扣除子弹
            gameData.gameState.playerBullets -= move.cost;
            
            // 处理特殊招式使用次数
            if (moveId === 'singleReflect') {
                gameData.gameState.playerSpecialMoves.singleReflect--;
            } else if (moveId === 'megaReflect') {
                gameData.gameState.playerSpecialMoves.megaReflect--;
            } else if (moveId === 'landmine') {
                gameData.gameState.playerSpecialMoves.landmine--;
            } else if (moveId === 'smallFish') {
                gameData.gameState.playerSpecialMoves.smallFish--;
            }
            
            // 记录玩家的最后一招
            gameData.gameState.lastPlayerMove = moveId;
            
            // 显示玩家选择的招式
            document.getElementById('player-move').textContent = move.name;
            document.getElementById('player-move').classList.remove('hidden');
            document.getElementById('player-select').classList.add('hidden');
            
            // 切换到对手回合
            gameData.gameState.isPlayerTurn = false;
            
            // 更新游戏状态显示
            updateGameStateDisplay();
            
            // 延迟显示对手招式
            setTimeout(() => {
                const opponentMove = getOpponentMove();
                handleRoundResult(moveId, opponentMove);
            }, 1500);
        }

        // 获取对手招式（AI或模拟真实玩家）
        function getOpponentMove() {
            const availableMoves = [];
            
            // 遍历所有招式
            Object.keys(gameData.moves).forEach(moveId => {
                const move = gameData.moves[moveId];
                let canUse = true;
                
                // 检查子弹是否足够
                if (move.cost > gameData.gameState.opponentBullets) {
                    canUse = false;
                }
                
                // 检查特殊招式使用次数
                if (moveId === 'singleReflect' && gameData.gameState.opponentSpecialMoves.singleReflect <= 0) {
                    canUse = false;
                }
                
                if (moveId === 'megaReflect') {
                    if (gameData.gameState.opponentSpecialMoves.megaReflect <= 0 || gameData.gameState.currentRound < 4) {
                        canUse = false;
                    }
                }
                
                if (moveId === 'landmine') {
                    if (gameData.gameState.opponentSpecialMoves.landmine <= 0 || gameData.gameState.currentRound < 4) {
                        canUse = false;
                    }
                }
                
                if (moveId === 'smallFish' && gameData.gameState.opponentSpecialMoves.smallFish <= 0) {
                    canUse = false;
                }
                
                // 检查是否可以连出单反或地雷
                if ((moveId === 'singleReflect' || moveId === 'landmine') && gameData.gameState.lastOpponentMove === moveId) {
                    canUse = false;
                }
                
                if (canUse) {
                    availableMoves.push(moveId);
                }
            });
            
            // 根据游戏模式选择招式
            let selectedMove;
            
            if (gameData.gameState.gameMode === 'single' || gameData.gameState.gameMode === 'practice') {
                // 单人匹配模式和练习模式：使用基于难度的AI
                selectedMove = getDifficultyBasedAI(availableMoves);
            } else {
                // 练习模式：根据难度选择
                if (gameData.gameState.difficulty === 'easy') {
                    // 简单模式：随机选择
                    selectedMove = availableMoves[Math.floor(Math.random() * availableMoves.length)];
                } else if (gameData.gameState.difficulty === 'normal') {
                    // 普通模式：有一定策略
                    const strategyChance = Math.random();
                    
                    if (strategyChance < 0.7) {
                        // 70% 概率使用策略
                        selectedMove = getStrategicMove(availableMoves, 'normal');
                    } else {
                        // 30% 概率随机选择
                        selectedMove = availableMoves[Math.floor(Math.random() * availableMoves.length)];
                    }
                } else {
                    // 困难模式：高级策略
                    const strategyChance = Math.random();
                    
                    if (strategyChance < 0.9) {
                        // 90% 概率使用策略
                        selectedMove = getStrategicMove(availableMoves, 'hard');
                    } else {
                        // 10% 概率随机选择
                        selectedMove = availableMoves[Math.floor(Math.random() * availableMoves.length)];
                    }
                }
            }
            
            return selectedMove;
        }
        
        // 基于难度的AI，用于单人模式和练习模式
        function getDifficultyBasedAI(availableMoves) {
            // 获取当前难度
            let aiDifficulty = gameData.gameState.difficulty;
            
            // 单人模式下，根据玩家积分调整难度
            if (gameData.gameState.gameMode === 'single') {
                const playerScore = gameData.currentUser ? gameData.currentUser.score : 0;
                
                if (playerScore < 10) {
                    aiDifficulty = 'easy';
                } else if (playerScore < 30) {
                    aiDifficulty = 'normal';
                } else if (playerScore < 60) {
                    aiDifficulty = 'hard';
                } else {
                    aiDifficulty = 'expert'; // 专家难度，比困难更难
                }
            }
            
            // 根据难度选择策略
            const randomChance = Math.random();
            let selectedMove;
            
            if (aiDifficulty === 'easy') {
                // 简单AI：主要随机选择
                if (randomChance < 0.5) {
                    selectedMove = getStrategicMove(availableMoves, 'normal');
                } else {
                    selectedMove = availableMoves[Math.floor(Math.random() * availableMoves.length)];
                }
            } else if (aiDifficulty === 'normal') {
                // 普通AI：中等策略
                if (randomChance < 0.8) {
                    selectedMove = getStrategicMove(availableMoves, 'normal');
                } else {
                    selectedMove = availableMoves[Math.floor(Math.random() * availableMoves.length)];
                }
            } else if (aiDifficulty === 'hard') {
                // 困难AI：高策略性
                if (randomChance < 0.95) {
                    selectedMove = getStrategicMove(availableMoves, 'hard');
                } else {
                    selectedMove = availableMoves[Math.floor(Math.random() * availableMoves.length)];
                }
            } else {
                // 专家AI：极高策略性，使用豆包AI
                if (randomChance < 0.98) {
                    selectedMove = getDoubaoAIMove(availableMoves);
                } else {
                    selectedMove = availableMoves[Math.floor(Math.random() * availableMoves.length)];
                }
            }
            
            return selectedMove;
        }

        // 单人模式专用AI，基于玩家积分调整难度
        function getSinglePlayerAI(availableMoves) {
            // 获取玩家积分
            const playerScore = gameData.currentUser ? gameData.currentUser.score : 0;
            
            // 根据玩家积分确定AI难度
            let aiDifficulty;
            if (playerScore < 10) {
                aiDifficulty = 'easy';
            } else if (playerScore < 30) {
                aiDifficulty = 'normal';
            } else if (playerScore < 60) {
                aiDifficulty = 'hard';
            } else {
                aiDifficulty = 'expert'; // 专家难度，比困难更难
            }
            
            // 根据难度选择策略
            const randomChance = Math.random();
            let selectedMove;
            
            if (aiDifficulty === 'easy') {
                // 简单AI：主要随机选择
                if (randomChance < 0.5) {
                    selectedMove = getStrategicMove(availableMoves, 'normal');
                } else {
                    selectedMove = availableMoves[Math.floor(Math.random() * availableMoves.length)];
                }
            } else if (aiDifficulty === 'normal') {
                // 普通AI：中等策略
                if (randomChance < 0.8) {
                    selectedMove = getStrategicMove(availableMoves, 'normal');
                } else {
                    selectedMove = availableMoves[Math.floor(Math.random() * availableMoves.length)];
                }
            } else if (aiDifficulty === 'hard') {
                // 困难AI：高策略性
                if (randomChance < 0.95) {
                    selectedMove = getStrategicMove(availableMoves, 'hard');
                } else {
                    selectedMove = availableMoves[Math.floor(Math.random() * availableMoves.length)];
                }
            } else {
                // 专家AI：极高策略性，使用豆包AI
                if (randomChance < 0.98) {
                    selectedMove = getDoubaoAIMove(availableMoves);
                } else {
                    selectedMove = availableMoves[Math.floor(Math.random() * availableMoves.length)];
                }
            }
            
            return selectedMove;
        }

        // 获取策略性招式
        function getStrategicMove(availableMoves, difficulty) {
            // 困难模式下使用强力AI：豆包AI
            if (difficulty === 'hard') {
                return getDoubaoAIMove(availableMoves);
            }

            // 基于当前游戏状态选择最优招式
            const playerBullets = gameData.gameState.playerBullets;
            const opponentBullets = gameData.gameState.opponentBullets;
            const currentRound = gameData.gameState.currentRound;
            
            // 优先上弹
            if (opponentBullets < 3 && availableMoves.includes('reload')) {
                return 'reload';
            }
            
            // 如果有足够子弹，尝试使用强力招式
            if (opponentBullets >= 5 && availableMoves.includes('nuke')) {
                return 'nuke';
            }
            
            if (opponentBullets >= 3 && availableMoves.includes('wave')) {
                return 'wave';
            }
            
            if (opponentBullets >= 2 && availableMoves.includes('doubleGun')) {
                return 'doubleGun';
            }
            
            if (opponentBullets >= 1 && availableMoves.includes('singleGun')) {
                return 'singleGun';
            }
            
            // 如果玩家有很多子弹，考虑防御
            if (playerBullets >= 3) {
                if (availableMoves.includes('waveShield')) return 'waveShield';
                if (availableMoves.includes('normalShield')) return 'normalShield';
                if (availableMoves.includes('nukeShield')) return 'nukeShield';
            }
            
            // 第4回合后考虑使用特殊招式
            if (currentRound >= 4) {
                if (availableMoves.includes('landmine') && gameData.gameState.opponentSpecialMoves.landmine > 0) {
                    return 'landmine';
                }
                
                if (availableMoves.includes('megaReflect') && gameData.gameState.opponentSpecialMoves.megaReflect > 0) {
                    return 'megaReflect';
                }
            }
            
            // 如果玩家没有子弹，考虑使用小鱼
            if (playerBullets > 0 && availableMoves.includes('smallFish') && gameData.gameState.opponentSpecialMoves.smallFish > 0) {
                return 'smallFish';
            }
            
            // 最后随机选择
            return availableMoves[Math.floor(Math.random() * availableMoves.length)];
        }

        // 豆包AI：强力AI，用于困难模式
        function getDoubaoAIMove(availableMoves) {
            const playerBullets = gameData.gameState.playerBullets;
            const opponentBullets = gameData.gameState.opponentBullets;
            const currentRound = gameData.gameState.currentRound;
            const lastPlayerMove = gameData.gameState.lastPlayerMove;
            const gameHistory = gameData.gameState.roundHistory || [];

            // 分析玩家行为模式
            const playerPattern = analyzePlayerPattern(gameHistory);

            // 1. 防御优先策略：预测并防御玩家的攻击
            if (playerPattern.likelyNextMove) {
                const counterMove = getCounterMove(playerPattern.likelyNextMove, availableMoves);
                if (counterMove) {
                    return counterMove;
                }
            }

            // 2. 资源管理：保持子弹优势
            if (opponentBullets < playerBullets - 1 && availableMoves.includes('reload')) {
                return 'reload';
            }

            // 3. 强力攻击：在优势时果断出击
            if (opponentBullets >= 5 && availableMoves.includes('nuke')) {
                // 如果玩家可能防御核弹，就不用
                if (!playerPattern.mightUseNukeShield) {
                    return 'nuke';
                }
            }

            if (opponentBullets >= 3 && availableMoves.includes('wave')) {
                // 如果玩家可能防御波，就不用
                if (!playerPattern.mightUseWaveShield) {
                    return 'wave';
                }
            }

            // 4. 特殊招式时机把握
            if (currentRound >= 4) {
                // 地雷：在玩家可能上弹或攻击时使用
                if (availableMoves.includes('landmine') && gameData.gameState.opponentSpecialMoves.landmine > 0) {
                    if (playerPattern.likelyNextMove === 'reload' || ['singleGun', 'doubleGun', 'wave'].includes(playerPattern.likelyNextMove)) {
                        return 'landmine';
                    }
                }

                // 巨反：在玩家可能使用强力攻击时使用
                if (availableMoves.includes('megaReflect') && gameData.gameState.opponentSpecialMoves.megaReflect > 0) {
                    if (playerBullets >= 3) {
                        return 'megaReflect';
                    }
                }
            }

            // 5. 小鱼：在玩家子弹多时使用
            if (playerBullets >= 3 && availableMoves.includes('smallFish') && gameData.gameState.opponentSpecialMoves.smallFish > 0) {
                return 'smallFish';
            }

            // 6. 精准防御
            if (playerBullets >= 1) {
                if (playerPattern.likelyNextMove === 'singleGun' && availableMoves.includes('normalShield')) {
                    return 'normalShield';
                }
                if (playerPattern.likelyNextMove === 'doubleGun' && availableMoves.includes('normalShield')) {
                    return 'normalShield';
                }
                if (playerPattern.likelyNextMove === 'wave' && availableMoves.includes('waveShield')) {
                    return 'waveShield';
                }
                if (playerPattern.likelyNextMove === 'nuke' && availableMoves.includes('nukeShield')) {
                    return 'nukeShield';
                }
            }

            // 7. 单反：在玩家可能使用单枪/双枪时使用
            if (availableMoves.includes('singleReflect') && gameData.gameState.opponentSpecialMoves.singleReflect > 0) {
                if (['singleGun', 'doubleGun'].includes(playerPattern.likelyNextMove)) {
                    return 'singleReflect';
                }
            }

            // 8.  fallback策略：随机但加权
            const weightedMoves = [];
            availableMoves.forEach(move => {
                let weight = 1;
                if (move === 'reload' && opponentBullets < 3) weight = 3;
                if (move === 'singleGun' && opponentBullets >= 1) weight = 2;
                if (move === 'doubleGun' && opponentBullets >= 2) weight = 2;
                if (move === 'wave' && opponentBullets >= 3) weight = 2;
                for (let i = 0; i < weight; i++) {
                    weightedMoves.push(move);
                }
            });
            return weightedMoves[Math.floor(Math.random() * weightedMoves.length)];
        }

        // 分析玩家行为模式
        function analyzePlayerPattern(history) {
            if (history.length < 2) {
                return { likelyNextMove: null, mightUseNukeShield: false, mightUseWaveShield: false };
            }

            const lastRound = history[history.length - 1];
            const secondLastRound = history[history.length - 2];
            const playerMoves = history.map(r => r.playerMove);
            const playerBulletsHistory = history.map(r => r.playerBullets);

            // 简单的模式识别
            let likelyNextMove = null;
            let mightUseNukeShield = false;
            let mightUseWaveShield = false;

            // 如果玩家刚上弹，很可能下一步攻击
            if (lastRound.playerMove === 'reload') {
                if (lastRound.playerBullets >= 1) likelyNextMove = 'singleGun';
                if (lastRound.playerBullets >= 2) likelyNextMove = 'doubleGun';
                if (lastRound.playerBullets >= 3) likelyNextMove = 'wave';
            }

            // 如果玩家连续使用某种攻击，可能继续
            const lastTwoMoves = playerMoves.slice(-2);
            if (lastTwoMoves[0] === lastTwoMoves[1] && lastTwoMoves[0] !== 'reload') {
                likelyNextMove = lastTwoMoves[0];
            }

            // 判断玩家是否可能使用防御
            const recentPlayerBullets = playerBulletsHistory.slice(-3);
            if (recentPlayerBullets.some(b => b >= 5)) {
                mightUseNukeShield = true;
            }
            if (recentPlayerBullets.some(b => b >= 3)) {
                mightUseWaveShield = true;
            }

            return { likelyNextMove, mightUseNukeShield, mightUseWaveShield };
        }

        // 获取针对特定招式的 counter move
        function getCounterMove(playerMove, availableMoves) {
            const counters = {
                'singleGun': ['normalShield', 'singleReflect'],
                'doubleGun': ['normalShield', 'singleReflect'],
                'wave': ['waveShield', 'normalShield'],
                'nuke': ['nukeShield'],
                'landmine': ['nukeShield'],
                'smallFish': ['megaReflect'],
                'reload': ['landmine']
            };

            if (counters[playerMove]) {
                for (const counter of counters[playerMove]) {
                    if (availableMoves.includes(counter)) {
                        return counter;
                    }
                }
            }
            return null;
        }

        // 模拟真实玩家的行为
        function simulateRealPlayerMove(availableMoves) {
            // 基于当前游戏状态模拟真实玩家的策略
            const playerBullets = gameData.gameState.playerBullets;
            const opponentBullets = gameData.gameState.opponentBullets;
            const currentRound = gameData.gameState.currentRound;
            const lastPlayerMove = gameData.gameState.lastPlayerMove;
            
            // 真实玩家不会总是选择最优策略，会有一些随机性
            const randomChance = Math.random();
            
            if (randomChance < 0.3) {
                // 30% 概率随机选择（模拟玩家的不确定性）
                return availableMoves[Math.floor(Math.random() * availableMoves.length)];
            }
            
            // 70% 概率使用策略性出牌
            
            // 观察玩家的行为模式
            if (lastPlayerMove === 'reload' && availableMoves.includes('singleGun')) {
                // 如果玩家刚上弹，有概率直接攻击
                if (Math.random() < 0.6) {
                    return 'singleGun';
                }
            }
            
            // 基本策略：保持子弹数量
            if (opponentBullets < 2 && availableMoves.includes('reload')) {
                return 'reload';
            }
            
            // 攻击策略
            if (opponentBullets >= 3 && availableMoves.includes('wave')) {
                return 'wave';
            }
            
            if (opponentBullets >= 2 && availableMoves.includes('doubleGun')) {
                return 'doubleGun';
            }
            
            if (opponentBullets >= 1 && availableMoves.includes('singleGun')) {
                return 'singleGun';
            }
            
            // 防御策略
            if (playerBullets >= 3) {
                const shields = ['waveShield', 'normalShield', 'nukeShield'].filter(s => availableMoves.includes(s));
                if (shields.length > 0) {
                    return shields[Math.floor(Math.random() * shields.length)];
                }
            }
            
            // 特殊招式策略
            if (currentRound >= 4) {
                // 有概率使用地雷
                if (availableMoves.includes('landmine') && gameData.gameState.opponentSpecialMoves.landmine > 0 && Math.random() < 0.4) {
                    return 'landmine';
                }
                
                // 有概率使用巨反
                if (availableMoves.includes('megaReflect') && gameData.gameState.opponentSpecialMoves.megaReflect > 0 && Math.random() < 0.3) {
                    return 'megaReflect';
                }
            }
            
            // 小鱼策略
            if (playerBullets > 2 && availableMoves.includes('smallFish') && gameData.gameState.opponentSpecialMoves.smallFish > 0 && Math.random() < 0.5) {
                return 'smallFish';
            }
            
            // 单反策略
            if (availableMoves.includes('singleReflect') && gameData.gameState.opponentSpecialMoves.singleReflect > 0 && Math.random() < 0.2) {
                return 'singleReflect';
            }
            
            // 默认策略
            return availableMoves[Math.floor(Math.random() * availableMoves.length)];
        }

        // 获取在线玩家列表（模拟）
        function getOnlinePlayers() {
            // 从用户数据中随机选择一些作为在线玩家
            const allUsers = Object.values(gameData.users);
            const onlinePlayers = [];
            
            // 过滤掉当前用户
            allUsers.forEach(user => {
                if (user.username !== gameData.currentUser.username) {
                    // 模拟在线状态
                    if (Math.random() < 0.7) { // 70% 概率在线
                        onlinePlayers.push(user);
                    }
                }
            });
            
            // 如果没有其他用户，创建一些模拟用户
            if (onlinePlayers.length === 0) {
                const mockPlayers = [
                    { username: '玩家A', score: 15 },
                    { username: '玩家B', score: 8 },
                    { username: '玩家C', score: 22 },
                    { username: '玩家D', score: 5 },
                    { username: '玩家E', score: 11 }
                ];
                
                // 随机选择1-3个模拟玩家
                const numPlayers = Math.floor(Math.random() * 3) + 1;
                for (let i = 0; i < numPlayers; i++) {
                    onlinePlayers.push(mockPlayers[i]);
                }
            }
            
            return onlinePlayers;
        }

        // 处理回合结果
        function handleRoundResult(playerMove, opponentMove) {
            // 记录对手的最后一招
            gameData.gameState.lastOpponentMove = opponentMove;
            
            // 显示对手选择的招式
            document.getElementById('opponent-move').textContent = gameData.moves[opponentMove].name;
            document.getElementById('opponent-move').classList.remove('hidden');
            document.getElementById('opponent-thinking').classList.add('hidden');
            
            // 获取招式数据
            const playerMoveData = gameData.moves[playerMove];
            const opponentMoveData = gameData.moves[opponentMove];
            
            // 战斗结果区域
            const battleResult = document.getElementById('battle-result');
            const resultText = document.getElementById('result-text');
            const resultDescription = document.getElementById('result-description');
            
            // 初始化结果
            let playerWins = false;
            let opponentWins = false;
            let isDraw = false;
            let description = '';
            
            // 处理上弹（先处理）
            if (playerMove === 'reload') {
                gameData.gameState.playerBullets += 1;
                description += '你使用了上弹，子弹+1。';
            }
            
            if (opponentMove === 'reload') {
                gameData.gameState.opponentBullets += 1;
                description += '对手使用了上弹，子弹+1。';
            }
            
            // 处理小鱼（后处理，在上弹之后，确保能吸到当前回合上的子弹）
            if (playerMove === 'smallFish') {
                // 检查小鱼是否被抵消或杀死
                if (['singleGun', 'doubleGun', 'singleReflect', 'landmine', 'wave', 'nuke'].includes(opponentMove)) {
                    if (['singleGun', 'doubleGun', 'singleReflect', 'landmine'].includes(opponentMove)) {
                        description += `你的小鱼与对手的${opponentMoveData.name}抵消了！`;
                    } else {
                        description += `你的小鱼被对手的${opponentMoveData.name}杀死了！`;
                    }
                } else if (opponentMove === 'megaReflect') {
                    // 巨反反弹小鱼
                    const stolenBullets = gameData.gameState.playerBullets;
                    gameData.gameState.playerBullets = 0;
                    gameData.gameState.opponentBullets += stolenBullets;
                    description += '你的小鱼被对手的巨反反弹了！你失去了所有子弹，对手获得了你的子弹。';
                } else {
                    // 小鱼吸取子弹（吸取所有）
                    const stolenBullets = gameData.gameState.opponentBullets;
                    gameData.gameState.opponentBullets = 0;
                    gameData.gameState.playerBullets += stolenBullets;
                    description += `你使用了小鱼，吸取了对手所有${stolenBullets}颗子弹！`;
                }
            }
            
            if (opponentMove === 'smallFish') {
                // 检查小鱼是否被抵消或杀死
                if (['singleGun', 'doubleGun', 'singleReflect', 'landmine', 'wave', 'nuke'].includes(playerMove)) {
                    if (['singleGun', 'doubleGun', 'singleReflect', 'landmine'].includes(playerMove)) {
                        description += `对手的小鱼与你的${playerMoveData.name}抵消了！`;
                    } else {
                        description += `对手的小鱼被你的${playerMoveData.name}杀死了！`;
                    }
                } else if (playerMove === 'megaReflect') {
                    // 巨反反弹小鱼
                    const stolenBullets = gameData.gameState.opponentBullets;
                    gameData.gameState.opponentBullets = 0;
                    gameData.gameState.playerBullets += stolenBullets;
                    description += '对手的小鱼被你的巨反反弹了！对手失去了所有子弹，你获得了对手的子弹。';
                } else {
                    // 小鱼吸取子弹（吸取所有）
                    const stolenBullets = gameData.gameState.playerBullets;
                    gameData.gameState.playerBullets = 0;
                    gameData.gameState.opponentBullets += stolenBullets;
                    description += `对手使用了小鱼，吸取了你所有${stolenBullets}颗子弹！`;
                }
            }
            
            // 处理反弹
            let playerMoveToCheck = playerMove;
            let opponentMoveToCheck = opponentMove;
            
            // 单反反弹
            if (playerMove === 'singleReflect' && ['singleGun', 'doubleGun'].includes(opponentMove)) {
                opponentMoveToCheck = 'reflected';
                description += '你的单反反弹了对手的攻击！';
                // 减少AI的特殊技能次数
                gameData.gameState.opponentSpecialMoves.singleReflect--;
            }
            
            if (opponentMove === 'singleReflect' && ['singleGun', 'doubleGun'].includes(playerMove)) {
                playerMoveToCheck = 'reflected';
                description += '对手的单反反弹了你的攻击！';
            }
            
            // 巨反反弹
            if (playerMove === 'megaReflect' && opponentMove !== 'reload') {
                opponentMoveToCheck = 'reflected';
                description += '你的巨反反弹了对手的攻击！';
                // 减少AI的特殊技能次数
                gameData.gameState.opponentSpecialMoves.megaReflect--;
            }
            
            if (opponentMove === 'megaReflect' && playerMove !== 'reload') {
                playerMoveToCheck = 'reflected';
                description += '对手的巨反反弹了你的攻击！';
            }
            
            // 波防防御波并反弹地雷
            if (playerMove === 'waveShield') {
                if (opponentMove === 'wave') {
                    opponentMoveToCheck = 'blocked';
                    description += '你的波防防御了对手的波！';
                } else if (opponentMove === 'landmine') {
                    opponentMoveToCheck = 'reflected';
                    description += '你的波防反弹了对手的地雷！';
                    // 减少AI的特殊技能次数
                    gameData.gameState.opponentSpecialMoves.landmine--;
                }
            }
            
            if (opponentMove === 'waveShield') {
                if (playerMove === 'wave') {
                    playerMoveToCheck = 'blocked';
                    description += '对手的波防防御了你的波！';
                } else if (playerMove === 'landmine') {
                    playerMoveToCheck = 'reflected';
                    description += '对手的波防反弹了你的地雷！';
                }
            }
            
            // 核防防御核弹，与地雷抵消
            if (playerMove === 'nukeShield') {
                if (opponentMove === 'nuke') {
                    opponentMoveToCheck = 'blocked';
                    description += '你的核防防御了对手的核弹！';
                } else if (opponentMove === 'landmine') {
                    // 核防与地雷抵消
                    opponentMoveToCheck = 'blocked';
                    playerMoveToCheck = 'blocked';
                    description += '你的核防与对手的地雷抵消了！';
                    // 减少AI的特殊技能次数
                    gameData.gameState.opponentSpecialMoves.landmine--;
                }
            }
            
            if (opponentMove === 'nukeShield') {
                if (playerMove === 'nuke') {
                    playerMoveToCheck = 'blocked';
                    description += '对手的核防防御了你的核弹！';
                } else if (playerMove === 'landmine') {
                    // 核防与地雷抵消
                    playerMoveToCheck = 'blocked';
                    opponentMoveToCheck = 'blocked';
                    description += '对手的核防与你的地雷抵消了！';
                }
            }
            
            // 普防与单枪、双枪、地雷抵消
            if (playerMove === 'normalShield' && ['singleGun', 'doubleGun', 'landmine'].includes(opponentMove)) {
                opponentMoveToCheck = 'blocked';
                playerMoveToCheck = 'blocked';
                description += '你的普防与对手的攻击抵消了！';
                // 如果是地雷，减少AI的特殊技能次数
                if (opponentMove === 'landmine') {
                    gameData.gameState.opponentSpecialMoves.landmine--;
                }
            }
            
            if (opponentMove === 'normalShield' && ['singleGun', 'doubleGun', 'landmine'].includes(playerMove)) {
                playerMoveToCheck = 'blocked';
                opponentMoveToCheck = 'blocked';
                description += '对手的普防与你的攻击抵消了！';
            }
            
            // 判断攻击是否有效
            if (playerMoveToCheck !== 'blocked' && playerMoveToCheck !== 'reflected') {
                if (playerMoveData.counters && playerMoveData.counters.includes(opponentMove)) {
                    opponentWins = true;
                    description += `你的${playerMoveData.name}击败了对手的${opponentMoveData.name}！`;
                }
            }
            
            if (opponentMoveToCheck !== 'blocked' && opponentMoveToCheck !== 'reflected') {
                if (opponentMoveData.counters && opponentMoveData.counters.includes(playerMove)) {
                    playerWins = true;
                    description += `对手的${opponentMoveData.name}击败了你的${playerMoveData.name}！`;
                }
            }
            
            // 处理反弹的攻击
            if (playerMoveToCheck === 'reflected') {
                if (opponentMoveData.counters && opponentMoveData.counters.includes(playerMove)) {
                    playerWins = true;
                    description += '反弹的攻击对你造成了伤害！';
                }
            }
            
            if (opponentMoveToCheck === 'reflected') {
                if (playerMoveData.counters && playerMoveData.counters.includes(opponentMove)) {
                    opponentWins = true;
                    description += '反弹的攻击对对手造成了伤害！';
                }
            }
            
            // 判断回合结果
            if (playerWins && opponentWins) {
                isDraw = true;
                resultText.textContent = '平局';
                resultText.className = 'text-xl font-bold text-yellow-400';
            } else if (playerWins) {
                resultText.textContent = '你输了';
                resultText.className = 'text-xl font-bold text-red-400';
                gameData.gameState.isGameOver = true;
                gameData.gameState.winner = 'opponent';
            } else if (opponentWins) {
                resultText.textContent = '你赢了';
                resultText.className = 'text-xl font-bold text-green-400';
                gameData.gameState.isGameOver = true;
                gameData.gameState.winner = 'player';
            } else {
                isDraw = true;
                resultText.textContent = '平局';
                resultText.className = 'text-xl font-bold text-yellow-400';
            }
            
            resultDescription.textContent = description;
            battleResult.classList.remove('hidden');
            
            // 更新游戏状态显示
            updateGameStateDisplay();
            
            // 如果游戏结束，显示结果
            if (gameData.gameState.isGameOver) {
                setTimeout(() => {
                    endGame();
                }, 3000);
            } else {
                // 进入下一回合
                setTimeout(() => {
                    nextRound();
                }, 3000);
            }
        }

        // 进入下一回合
        function nextRound() {
            // 增加回合数
            gameData.gameState.currentRound++;
            
            // 重置回合状态
            gameData.gameState.isPlayerTurn = true;
            
            // 隐藏战斗结果
            document.getElementById('battle-result').classList.add('hidden');
            
            // 隐藏招式显示
            document.getElementById('player-move').classList.add('hidden');
            document.getElementById('player-select').classList.remove('hidden');
            document.getElementById('opponent-move').classList.add('hidden');
            document.getElementById('opponent-thinking').classList.remove('hidden');
            
            // 更新游戏状态显示
            updateGameStateDisplay();
        }

        // 结束游戏
        function endGame() {
            // 计算积分变化（仅在单人模式下）
            if (gameData.gameState.gameMode === 'single') {
                if (gameData.gameState.winner === 'player') {
                    gameData.gameState.scoreChange = 2;
                    gameData.currentUser.score += 2;
                } else {
                    gameData.gameState.scoreChange = -1;
                    if (gameData.currentUser.score > 0) {
                        gameData.currentUser.score -= 1;
                    }
                }
                
                // 保存用户数据
                gameData.users[gameData.currentUser.username] = gameData.currentUser;
                localStorage.setItem('fishGameUsers', JSON.stringify(gameData.users));
            } else {
                gameData.gameState.scoreChange = 0;
            }
            
            // 更新游戏结束界面
            document.getElementById('game-result-title').textContent = gameData.gameState.winner === 'player' ? '恭喜你赢了！' : '很遗憾你输了！';
            document.getElementById('game-result-message').textContent = gameData.gameState.winner === 'player' ? '你成功击败了对手！' : '你被对手击败了！';
            
            document.getElementById('result-game-mode').textContent = gameData.gameState.gameMode === 'practice' ? '练习模式' : '单人匹配';
            document.getElementById('result-difficulty').textContent = gameData.gameState.difficulty === 'easy' ? '简单' : (gameData.gameState.difficulty === 'normal' ? '普通' : '困难');
            document.getElementById('result-rounds').textContent = gameData.gameState.currentRound;
            
            const scoreChangeElement = document.getElementById('result-score-change');
            scoreChangeElement.textContent = (gameData.gameState.scoreChange > 0 ? '+' : '') + gameData.gameState.scoreChange;
            scoreChangeElement.className = 'font-bold ' + (gameData.gameState.scoreChange > 0 ? 'text-green-400' : 'text-red-400');
            
            document.getElementById('result-current-score').textContent = gameData.currentUser.score;
            
            // 显示游戏结束界面
            showScreen('gameOver');
        }

        // 开始新游戏
        function startNewGame() {
            // 重置游戏状态
            gameData.gameState = {
                currentRound: 1,
                playerBullets: 0,
                opponentBullets: 0,
                playerSpecialMoves: {
                    singleReflect: 2,
                    megaReflect: 1,
                    landmine: 2,
                    smallFish: 1
                },
                opponentSpecialMoves: {
                    singleReflect: 2,
                    megaReflect: 1,
                    landmine: 2,
                    smallFish: 1
                },
                gameMode: gameData.gameState.gameMode,
                difficulty: gameData.gameState.difficulty,
                roomId: gameData.gameState.roomId,
                isPlayerTurn: true,
                lastPlayerMove: null,
                lastOpponentMove: null,
                isGameOver: false,
                winner: null,
                scoreChange: 0,
                opponentPlayer: gameData.gameState.opponentPlayer || null
            };
            
            // 更新游戏界面显示
            document.getElementById('game-mode-display').textContent = gameData.gameState.gameMode === 'practice' ? '练习模式' : '单人匹配';
            
            // 单人模式下根据玩家积分显示AI难度
            if (gameData.gameState.gameMode === 'single') {
                const playerScore = gameData.currentUser ? gameData.currentUser.score : 0;
                let difficultyText;
                
                if (playerScore < 10) {
                    difficultyText = '简单';
                } else if (playerScore < 30) {
                    difficultyText = '普通';
                } else if (playerScore < 60) {
                    difficultyText = '困难';
                } else {
                    difficultyText = '专家';
                }
                
                document.getElementById('difficulty-display').textContent = difficultyText;
            } else {
                document.getElementById('difficulty-display').textContent = gameData.gameState.difficulty === 'easy' ? '简单' : (gameData.gameState.difficulty === 'normal' ? '普通' : '困难');
            }
            
            document.getElementById('player-name').textContent = gameData.currentUser.username;
            document.getElementById('opponent-name').textContent = gameData.gameState.gameMode === 'practice' ? 'AI对手' : (gameData.gameState.opponentPlayer ? gameData.gameState.opponentPlayer.username : '对手玩家');
            
            // 隐藏战斗结果
            document.getElementById('battle-result').classList.add('hidden');
            
            // 隐藏招式显示
            document.getElementById('player-move').classList.add('hidden');
            document.getElementById('player-select').classList.remove('hidden');
            document.getElementById('opponent-move').classList.add('hidden');
            document.getElementById('opponent-thinking').classList.remove('hidden');
            
            // 更新游戏状态显示
            updateGameStateDisplay();
            
            // 显示游戏界面
            showScreen('game');
        }

        // 初始化游戏
        function initGame() {
            // 登录表单提交
            document.getElementById('login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('login-username').value.trim();
                const password = document.getElementById('login-password').value;
                
                if (!username || !password) {
                    showNotification('登录失败', '请输入用户名和密码', 'error');
                    return;
                }
                
                const user = gameData.users[username];
                
                if (!user || user.password !== password) {
                    showNotification('登录失败', '用户名或密码错误', 'error');
                    return;
                }
                
                gameData.currentUser = user;
                document.getElementById('current-user').textContent = user.username;
                document.getElementById('current-score').textContent = user.score;
                
                showScreen('menu');
            });
            
            // 注册表单提交
            document.getElementById('register-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('register-username').value.trim();
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                
                if (!username || !password || !confirmPassword) {
                    showNotification('注册失败', '请填写所有字段', 'error');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showNotification('注册失败', '两次输入的密码不一致', 'error');
                    return;
                }
                
                if (gameData.users[username]) {
                    showNotification('注册失败', '用户名已存在', 'error');
                    return;
                }
                
                // 创建新用户
                const newUser = {
                    username: username,
                    password: password,
                    score: 0,
                    gameHistory: []
                };
                
                gameData.users[username] = newUser;
                localStorage.setItem('fishGameUsers', JSON.stringify(gameData.users));
                
                showNotification('注册成功', '账号创建成功，请登录', 'success');
                showScreen('login');
            });
            
            // 显示注册界面
            document.getElementById('show-register').addEventListener('click', function() {
                showScreen('register');
            });
            
            // 显示登录界面
            document.getElementById('show-login').addEventListener('click', function() {
                showScreen('login');
            });
            
            // 显示游戏规则
            document.getElementById('show-rules').addEventListener('click', function() {
                showScreen('rules');
            });
            
            // 从菜单显示游戏规则
            document.getElementById('show-rules-from-menu').addEventListener('click', function() {
                showScreen('rules');
            });
            
            // 关闭游戏规则
            document.getElementById('close-rules').addEventListener('click', function() {
                if (gameData.currentUser) {
                    showScreen('menu');
                } else {
                    showScreen('login');
                }
            });
            
            // 退出登录
            document.getElementById('logout').addEventListener('click', function() {
                gameData.currentUser = null;
                showScreen('login');
            });
            
            // 刷新排行榜
            document.getElementById('refresh-leaderboard').addEventListener('click', function() {
                updateLeaderboard();
                showNotification('刷新成功', '排行榜已更新', 'success');
            });
            
            // 练习模式
            document.getElementById('practice-mode').addEventListener('click', function() {
                gameData.gameState.gameMode = 'practice';
                showScreen('difficulty');
            });
            
            // 单人匹配
            document.getElementById('single-player').addEventListener('click', function() {
                // 设置游戏模式为单人匹配
                gameData.gameState.gameMode = 'single';
                
                // 获取在线玩家并匹配一个对手
                const onlinePlayers = getOnlinePlayers();
                if (onlinePlayers.length > 0) {
                    // 找到积分差距最小的玩家作为对手
                    let bestMatch = onlinePlayers[0];
                    let minScoreDiff = Math.abs(bestMatch.score - gameData.currentUser.score);
                    
                    onlinePlayers.forEach(player => {
                        const scoreDiff = Math.abs(player.score - gameData.currentUser.score);
                        if (scoreDiff < minScoreDiff) {
                            minScoreDiff = scoreDiff;
                            bestMatch = player;
                        }
                    });
                    
                    gameData.gameState.opponentPlayer = bestMatch;
                    showNotification('匹配成功', `已匹配到对手: ${bestMatch.username}`, 'success');
                } else {
                    // 如果没有其他玩家，创建一个AI对手
                    gameData.gameState.opponentPlayer = {
                        username: 'AI对手',
                        score: gameData.currentUser.score
                    };
                    showNotification('匹配中', '未找到其他玩家，已为您匹配AI对手', 'info');
                }
                
                // 开始游戏
                startNewGame();
            });
            
            // 多人联机
            document.getElementById('multi-player').addEventListener('click', function() {
                // 多人联机功能关闭，显示提示
                showNotification('功能未开放', '多人联机功能即将开放，敬请期待！', 'info');
            });
            
            // 难度选择
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    gameData.gameState.difficulty = this.dataset.difficulty;
                    startNewGame();
                });
            });
            
            // 返回主菜单（从难度选择）
            document.getElementById('back-to-menu-from-difficulty').addEventListener('click', function() {
                showScreen('menu');
            });
            
            // 创建房间
            document.getElementById('create-room').addEventListener('click', function() {
                // 多人联机功能关闭，显示提示
                showNotification('功能未开放', '多人联机功能即将开放，敬请期待！', 'info');
            });
            
            // 快速加入
            document.getElementById('quick-join').addEventListener('click', function() {
                // 多人联机功能关闭，显示提示
                showNotification('功能未开放', '多人联机功能即将开放，敬请期待！', 'info');
            });
            
            // 加入房间
            document.getElementById('join-room').addEventListener('click', function() {
                // 多人联机功能关闭，显示提示
                showNotification('功能未开放', '多人联机功能即将开放，敬请期待！', 'info');
            });
            
            // 返回主菜单（从多人联机）
            document.getElementById('back-to-menu-from-multiplayer').addEventListener('click', function() {
                showScreen('menu');
            });
            
            // 返回主菜单（从局域网对战）
            document.getElementById('back-to-menu-from-lan').addEventListener('click', function() {
                showScreen('menu');
            });
            
            // 创建局域网游戏
            document.getElementById('create-lan-game').addEventListener('click', function() {
                // 多人联机功能关闭，显示提示
                showNotification('功能未开放', '多人联机功能即将开放，敬请期待！', 'info');
            });
            
            // 加入局域网游戏
            document.getElementById('join-lan-game').addEventListener('click', function() {
                // 多人联机功能关闭，显示提示
                showNotification('功能未开放', '多人联机功能即将开放，敬请期待！', 'info');
            });
            
            // 准备
            document.getElementById('ready-up').addEventListener('click', function() {
                // 多人联机功能关闭，显示提示
                showNotification('功能未开放', '多人联机功能即将开放，敬请期待！', 'info');
            });
            
            // 离开房间
            document.getElementById('leave-room').addEventListener('click', function() {
                showScreen('multiplayer');
            });
            
            // 退出游戏
            document.getElementById('exit-game').addEventListener('click', function() {
                showScreen('menu');
            });
            
            // 再来一局
            document.getElementById('play-again').addEventListener('click', function() {
                startNewGame();
            });
            
            // 返回主菜单（从游戏结束）
            document.getElementById('back-to-menu-from-game-over').addEventListener('click', function() {
                document.getElementById('current-score').textContent = gameData.currentUser.score;
                showScreen('menu');
            });
            
            // 关闭通知
            document.getElementById('close-notification').addEventListener('click', function() {
                hideNotification();
            });
            
            // 招式选择
            document.querySelectorAll('.move-card').forEach(card => {
                card.addEventListener('click', function() {
                    const moveId = this.dataset.move;
                    handlePlayerMove(moveId);
                });
            });
            
            // 显示登录界面
            showScreen('login');
        }

        // 页面加载完成后初始化游戏
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
